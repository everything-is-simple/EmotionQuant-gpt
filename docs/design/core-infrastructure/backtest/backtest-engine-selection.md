# 回测引擎选型设计（Spiral 版）

**版本**: v1.1.0
**最后更新**: 2026-02-07
**状态**: 选型决策文档（ADR）

---

## 1. 决策

采用“主选平台 + 可替换引擎”架构：

- 主选平台：`Qlib`（研究回测/因子研究主平台）
- 执行基线：本地向量化回测器（A 股执行规则对齐）
- 兼容实现：`backtrader` 适配器（保留，不作为主选）

---

## 2. 决策理由

1. 需要成熟、公开、社区活跃且近年持续更新的平台。
2. 需要覆盖因子研究工作流（数据处理、特征表达、实验管理），不只做撮合回测。
3. A 股执行规则（T+1、涨跌停、整手、费用）必须可在本地统一策略层复刻。

---

## 3. 边界

- Qlib 负责：研究回测、因子实验编排、实验记录。
- BacktestEngine 负责：撮合、持仓、绩效、A 股执行规则。
- Signal Provider 负责：提供统一推荐信号。
- 数据层负责：提供本地历史数据与交易日历。

---

## 4. 错误处理

| 级别 | 示例 | 处理 |
|---|---|---|
| P0 | 无交易日历/无行情 | 阻断，标记 FAIL |
| P1 | 个别标的缺数据 | 跳过并记录 WARN |
| P2 | 指标计算异常 | 重试或默认值，标记 WARN |

---

## 5. 验收

- 至少 1 个回测命令可复现。
- 至少 1 组 baseline 回测结果可对比。
- 至少 1 组候选权重 vs baseline 的 OOS 对照结果可复现。
- T+1 与涨跌停规则有自动化测试。
